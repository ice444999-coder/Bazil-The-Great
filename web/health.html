<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARES - System Health</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
        }

        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
        }

        .logo h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .logo p {
            font-size: 12px;
            opacity: 0.8;
        }

        .user-info {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
        }

        .user-info .username {
            font-weight: 600;
            font-size: 14px;
        }

        .user-info .role {
            font-size: 12px;
            opacity: 0.7;
        }

        .nav-menu {
            flex: 1;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            text-decoration: none;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-item.active {
            background: rgba(255,255,255,0.2);
            border-left: 3px solid white;
        }

        .logout-btn {
            padding: 12px 20px;
            margin: 20px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .header {
            margin-bottom: 30px;
        }

        .header h2 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .system-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px 20px;
            background: #d1fae5;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .grid-full {
            grid-column: 1 / -1;
        }

        /* Component Card */
        .component-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .component-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
        }

        .component-icon {
            font-size: 24px;
        }

        .status-badge {
            padding: 6px 15px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.healthy {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.error {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Info Row */
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 13px;
            color: #666;
        }

        .info-value {
            font-weight: 600;
            font-size: 14px;
        }

        .info-value.success {
            color: #10b981;
        }

        .info-value.warning {
            color: #f59e0b;
        }

        .info-value.error {
            color: #ef4444;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 20px;
        }

        /* Error Logs */
        .log-entry {
            padding: 15px;
            background: #f9fafb;
            border-left: 4px solid #ef4444;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .log-entry.warning {
            border-left-color: #f59e0b;
        }

        .log-entry.info {
            border-left-color: #3b82f6;
        }

        .log-time {
            color: #999;
            font-size: 11px;
            margin-bottom: 5px;
        }

        .log-message {
            color: #333;
        }

        .empty-logs {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* Metrics */
        .metric-box {
            text-align: center;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .metric-unit {
            font-size: 14px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #667eea);
            transition: width 0.3s;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #f59e0b, #ef4444);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h1>ARES</h1>
                <p>Autonomous AI Trading System</p>
            </div>

            <div class="user-info">
                <div class="username" id="username">Loading...</div>
                <div class="role">Administrator</div>
            </div>

            <nav class="nav-menu">
                <a href="/dashboard.html" class="nav-item">
                    <span class="icon">üè†</span>
                    <span>Dashboard</span>
                </a>
                <a href="/trading.html" class="nav-item">
                    <span class="icon">üìä</span>
                    <span>Trading</span>
                </a>
                <a href="/chat.html" class="nav-item">
                    <span class="icon">üí¨</span>
                    <span>Chat with SOLACE</span>
                </a>
                <a href="/editor.html" class="nav-item">
                    <span class="icon">üìù</span>
                    <span>Code Editor</span>
                </a>
                <a href="/memory.html" class="nav-item">
                    <span class="icon">üß†</span>
                    <span>Memory System</span>
                </a>
                <a href="/vision.html" class="nav-item">
                    <span class="icon">üëÅÔ∏è</span>
                    <span>SOLACE Vision</span>
                </a>
                <a href="/health.html" class="nav-item active">
                    <span class="icon">‚ù§Ô∏è</span>
                    <span>System Health</span>
                </a>
            </nav>

            <div class="logout-btn" onclick="logout()">
                üö™ Logout
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h2>System Health</h2>
                <p>Monitor all ARES components and infrastructure</p>
                <div class="system-status">
                    <div class="status-dot"></div>
                    <span id="overallStatus">All Systems Operational</span>
                </div>
            </div>

            <!-- Component Status Grid -->
            <div class="grid">
                <!-- LLM Status -->
                <div class="component-card">
                    <div class="component-header">
                        <div class="component-title">
                            <span class="component-icon">ü§ñ</span>
                            <span>LLM Engine</span>
                        </div>
                        <span class="status-badge healthy" id="llmStatus">Healthy</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Model</span>
                        <span class="info-value" id="llmModel">Loading...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status</span>
                        <span class="info-value success" id="llmConnectionStatus">Connected</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Avg Latency</span>
                        <span class="info-value" id="llmLatency">0ms</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Requests/min</span>
                        <span class="info-value" id="llmRequests">0</span>
                    </div>
                </div>

                <!-- Database Status -->
                <div class="component-card">
                    <div class="component-header">
                        <div class="component-title">
                            <span class="component-icon">üóÑÔ∏è</span>
                            <span>PostgreSQL</span>
                        </div>
                        <span class="status-badge healthy" id="dbStatus">Healthy</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Connection</span>
                        <span class="info-value success" id="dbConnection">Active</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">pgvector</span>
                        <span class="info-value success" id="pgvectorStatus">Installed</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Query Time</span>
                        <span class="info-value" id="dbQueryTime">0ms</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Active Connections</span>
                        <span class="info-value" id="dbConnections">0</span>
                    </div>
                </div>

                <!-- Trading Engine Status -->
                <div class="component-card">
                    <div class="component-header">
                        <div class="component-title">
                            <span class="component-icon">üìà</span>
                            <span>Trading Engine</span>
                        </div>
                        <span class="status-badge healthy" id="tradingStatus">Active</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Trading Enabled</span>
                        <span class="info-value success" id="tradingEnabled">Yes</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Open Positions</span>
                        <span class="info-value" id="openPositions">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Daily Loss</span>
                        <span class="info-value" id="dailyLoss">$0.00</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Max Loss Limit</span>
                        <span class="info-value" id="maxLoss">$500.00</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="lossProgress" style="width: 0%"></div>
                    </div>
                </div>

                <!-- ACE Framework Status -->
                <div class="component-card">
                    <div class="component-header">
                        <div class="component-title">
                            <span class="component-icon">üß†</span>
                            <span>ACE Framework</span>
                        </div>
                        <span class="status-badge healthy" id="aceStatus">Learning</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Total Rules</span>
                        <span class="info-value" id="totalRules">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Active Rules</span>
                        <span class="info-value success" id="activeRules">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Avg Confidence</span>
                        <span class="info-value" id="avgConfidence">0%</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Last Learning</span>
                        <span class="info-value" id="lastLearning">Never</span>
                    </div>
                </div>
            </div>

            <!-- API Performance Chart -->
            <div class="component-card grid-full">
                <div class="component-header">
                    <div class="component-title">
                        <span class="component-icon">‚ö°</span>
                        <span>API Response Times</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="apiChart"></canvas>
                </div>
            </div>

            <!-- System Metrics -->
            <div class="grid">
                <div class="component-card">
                    <div class="metric-box">
                        <div class="metric-label">Uptime</div>
                        <div class="metric-value" id="uptime">0h</div>
                    </div>
                </div>

                <div class="component-card">
                    <div class="metric-box">
                        <div class="metric-label">Total Requests</div>
                        <div class="metric-value" id="totalRequests">0</div>
                    </div>
                </div>

                <div class="component-card">
                    <div class="metric-box">
                        <div class="metric-label">Avg Response Time</div>
                        <div class="metric-value" id="avgResponseTime">0<span class="metric-unit">ms</span></div>
                    </div>
                </div>
            </div>

            <!-- Error Logs -->
            <div class="component-card grid-full">
                <div class="component-header">
                    <div class="component-title">
                        <span class="component-icon">üìã</span>
                        <span>Recent Logs</span>
                    </div>
                </div>
                <div id="logsContainer">
                    <div class="loading">Loading logs...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication
        const token = localStorage.getItem('ares_token');
        const user = JSON.parse(localStorage.getItem('ares_user') || '{}');

        if (!token) {
            window.location.href = '/login.html';
        }

        document.getElementById('username').textContent = user.username || 'User';

        function logout() {
            localStorage.removeItem('ares_token');
            localStorage.removeItem('ares_user');
            window.location.href = '/login.html';
        }

        // Chart.js API Response Times
        let apiChart;
        const ctx = document.getElementById('apiChart').getContext('2d');

        function initChart() {
            apiChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Response Time (ms)',
                        data: [],
                        backgroundColor: 'rgba(102, 126, 234, 0.5)',
                        borderColor: '#667eea',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + 'ms';
                                }
                            }
                        }
                    }
                }
            });
        }

        initChart();

        // Fetch health data
        async function fetchHealthData() {
            try {
                const response = await fetch('/api/v1/monitoring/health', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateHealthUI(data);
                }
            } catch (error) {
                console.error('Error fetching health data:', error);
                showError();
            }
        }

        function updateHealthUI(data) {
            // Overall status
            const overallHealthy = data.status === 'healthy';
            document.getElementById('overallStatus').textContent = overallHealthy ? 
                'All Systems Operational' : 'System Issues Detected';

            // LLM Status
            const llm = data.llm || {};
            document.getElementById('llmModel').textContent = llm.model || 'DeepSeek-R1 14B';
            document.getElementById('llmConnectionStatus').textContent = llm.connected ? 'Connected' : 'Disconnected';
            document.getElementById('llmLatency').textContent = (llm.latency || 0) + 'ms';
            document.getElementById('llmRequests').textContent = llm.requests_per_minute || 0;

            const llmStatusBadge = document.getElementById('llmStatus');
            if (llm.connected) {
                llmStatusBadge.textContent = 'Healthy';
                llmStatusBadge.className = 'status-badge healthy';
            } else {
                llmStatusBadge.textContent = 'Offline';
                llmStatusBadge.className = 'status-badge error';
            }

            // Database Status
            const db = data.database || {};
            document.getElementById('dbConnection').textContent = db.connected ? 'Active' : 'Disconnected';
            document.getElementById('pgvectorStatus').textContent = db.pgvector_installed ? 'Installed' : 'Missing';
            document.getElementById('dbQueryTime').textContent = (db.avg_query_time || 0) + 'ms';
            document.getElementById('dbConnections').textContent = db.active_connections || 0;

            const dbStatusBadge = document.getElementById('dbStatus');
            if (db.connected && db.pgvector_installed) {
                dbStatusBadge.textContent = 'Healthy';
                dbStatusBadge.className = 'status-badge healthy';
            } else {
                dbStatusBadge.textContent = 'Issue';
                dbStatusBadge.className = 'status-badge error';
            }

            // Trading Engine Status
            const trading = data.trading || {};
            document.getElementById('tradingEnabled').textContent = trading.enabled ? 'Yes' : 'No';
            document.getElementById('openPositions').textContent = trading.open_positions || 0;
            document.getElementById('dailyLoss').textContent = '$' + (trading.daily_loss || 0).toFixed(2);
            document.getElementById('maxLoss').textContent = '$' + (trading.max_loss_limit || 500).toFixed(2);

            const lossPercent = (trading.daily_loss || 0) / (trading.max_loss_limit || 500) * 100;
            const lossProgress = document.getElementById('lossProgress');
            lossProgress.style.width = Math.min(lossPercent, 100) + '%';
            lossProgress.className = lossPercent > 80 ? 'progress-fill warning' : 'progress-fill';

            const tradingStatusBadge = document.getElementById('tradingStatus');
            if (trading.enabled) {
                tradingStatusBadge.textContent = 'Active';
                tradingStatusBadge.className = 'status-badge healthy';
            } else {
                tradingStatusBadge.textContent = 'Disabled';
                tradingStatusBadge.className = 'status-badge warning';
            }

            // ACE Framework Status
            const ace = data.ace || {};
            document.getElementById('totalRules').textContent = ace.total_rules || 0;
            document.getElementById('activeRules').textContent = ace.active_rules || 0;
            document.getElementById('avgConfidence').textContent = ((ace.avg_confidence || 0) * 100).toFixed(0) + '%';
            document.getElementById('lastLearning').textContent = ace.last_learning || 'Never';

            // Metrics
            document.getElementById('uptime').textContent = data.uptime || '0h';
            document.getElementById('totalRequests').textContent = data.total_requests || 0;
            document.getElementById('avgResponseTime').textContent = data.avg_response_time || 0;

            // Update API chart
            updateAPIChart(data.api_performance || {});
        }

        function updateAPIChart(performance) {
            const endpoints = Object.keys(performance);
            const responseTimes = Object.values(performance);

            apiChart.data.labels = endpoints.map(e => e.split('/').pop() || e);
            apiChart.data.datasets[0].data = responseTimes;
            apiChart.update();
        }

        function showError() {
            document.getElementById('overallStatus').textContent = 'Unable to fetch health data';
        }

        // Load logs
        async function loadLogs() {
            try {
                const response = await fetch('/api/v1/monitoring/logs?limit=10', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayLogs(data.logs || []);
                } else {
                    document.getElementById('logsContainer').innerHTML = 
                        '<div class="empty-logs">No logs available</div>';
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                document.getElementById('logsContainer').innerHTML = 
                    '<div class="empty-logs">Failed to load logs</div>';
            }
        }

        function displayLogs(logs) {
            const container = document.getElementById('logsContainer');

            if (logs.length === 0) {
                container.innerHTML = '<div class="empty-logs">‚úÖ No errors! System running smoothly.</div>';
                return;
            }

            const html = logs.map(log => {
                const level = log.level || 'info';
                const time = new Date(log.timestamp).toLocaleString();
                
                return `
                    <div class="log-entry ${level}">
                        <div class="log-time">${time}</div>
                        <div class="log-message">${log.message || log.error || 'No message'}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Load initial data
        fetchHealthData();
        loadLogs();

        // Refresh every 10 seconds
        setInterval(fetchHealthData, 10000);
        setInterval(loadLogs, 30000);
    </script>
</body>
</html>
