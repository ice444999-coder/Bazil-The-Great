<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARES - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
        }

        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
        }

        .logo h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .logo p {
            font-size: 12px;
            opacity: 0.8;
        }

        .user-info {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
        }

        .user-info .username {
            font-weight: 600;
            font-size: 14px;
        }

        .user-info .role {
            font-size: 12px;
            opacity: 0.7;
        }

        .nav-menu {
            flex: 1;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            text-decoration: none;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-item.active {
            background: rgba(255,255,255,0.2);
            border-left: 3px solid white;
        }

        .nav-item .icon {
            font-size: 18px;
        }

        .logout-btn {
            padding: 12px 20px;
            margin: 20px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .header {
            margin-bottom: 30px;
        }

        .header h2 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .stat-card .label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card .value.positive {
            color: #10b981;
        }

        .stat-card .value.negative {
            color: #ef4444;
        }

        .stat-card .change {
            font-size: 12px;
            color: #666;
        }

        /* Content Sections */
        .section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-header h3 {
            font-size: 20px;
        }

        .section-header .view-all {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
        }

        .section-header .view-all:hover {
            text-decoration: underline;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f9fafb;
        }

        th {
            text-align: left;
            padding: 12px;
            font-weight: 600;
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px;
            border-top: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #f9fafb;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge.info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h1>ARES</h1>
                <p>Autonomous AI Trading System</p>
            </div>

            <div class="user-info">
                <div class="username" id="username">Loading...</div>
                <div class="role">Administrator</div>
            </div>

            <nav class="nav-menu">
                <a href="/dashboard.html" class="nav-item active">
                    <span class="icon">üè†</span>
                    <span>Dashboard</span>
                </a>
                <a href="/trading.html" class="nav-item">
                    <span class="icon">üìä</span>
                    <span>Trading</span>
                </a>
                <a href="/chat.html" class="nav-item">
                    <span class="icon">üí¨</span>
                    <span>Chat with SOLACE</span>
                </a>
                <a href="/editor.html" class="nav-item">
                    <span class="icon">üìù</span>
                    <span>Code Editor</span>
                </a>
                <a href="/memory.html" class="nav-item">
                    <span class="icon">üß†</span>
                    <span>Memory System</span>
                </a>
                <a href="/vision.html" class="nav-item">
                    <span class="icon">üëÅÔ∏è</span>
                    <span>SOLACE Vision</span>
                </a>
                <a href="/health.html" class="nav-item">
                    <span class="icon">‚ù§Ô∏è</span>
                    <span>System Health</span>
                </a>
            </nav>

            <div class="logout-btn" onclick="logout()">
                üö™ Logout
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h2>Dashboard</h2>
                <p>Welcome back! Here's what's happening with SOLACE.</p>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="label">Total P&L</div>
                    <div class="value positive" id="totalPnL">Loading...</div>
                    <div class="change" id="pnlChange">Calculating...</div>
                </div>

                <div class="stat-card">
                    <div class="label">Playbook Rules</div>
                    <div class="value" id="playbookRules">Loading...</div>
                    <div class="change" id="rulesChange">Active learning rules</div>
                </div>

                <div class="stat-card">
                    <div class="label">Total Memories</div>
                    <div class="value" id="totalMemories">Loading...</div>
                    <div class="change">Stored in semantic database</div>
                </div>

                <div class="stat-card">
                    <div class="label">System Status</div>
                    <div class="value" id="systemStatus">
                        <span class="badge info">Checking...</span>
                    </div>
                    <div class="change" id="statusDetail">Loading...</div>
                </div>
            </div>

            <!-- Recent Trades -->
            <div class="section">
                <div class="section-header">
                    <h3>Recent Trades</h3>
                    <a href="/trading.html" class="view-all">View All ‚Üí</a>
                </div>
                <div id="recentTradesTable">
                    <div class="loading">Loading trades...</div>
                </div>
            </div>

            <!-- ACE Framework Activity -->
            <div class="section">
                <div class="section-header">
                    <h3>ACE Framework Activity</h3>
                    <a href="/trading.html#playbook" class="view-all">View Playbook ‚Üí</a>
                </div>
                <div id="aceActivity">
                    <div class="loading">Loading ACE insights...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üî• AUTO-LOGIN FIX: If no token, login automatically with test credentials
        let token = localStorage.getItem('ares_token');
        
        // Safe JSON parsing - prevent "undefined" string being parsed
        let user = {};
        try {
            const userStr = localStorage.getItem('ares_user');
            if (userStr && userStr !== 'undefined' && userStr !== 'null') {
                user = JSON.parse(userStr);
            }
        } catch (e) {
            console.error('Failed to parse user data:', e);
            user = {};
        }

        // AUTO-LOGIN if no token exists
        if (!token) {
            console.log('üîë No token found - attempting auto-login...');
            
            fetch('/api/v1/users/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: 'solace_ai', password: 'test123' })
            })
            .then(res => res.json())
            .then(data => {
                if (data.token) {
                    console.log('‚úÖ Auto-login successful!');
                    localStorage.setItem('ares_token', data.token);
                    localStorage.setItem('ares_user', JSON.stringify(data.user));
                    location.reload(); // Reload to use new token
                } else {
                    console.error('‚ùå Auto-login failed:', data.error);
                    window.location.href = '/login.html';
                }
            })
            .catch(err => {
                console.error('‚ùå Auto-login error:', err);
                window.location.href = '/login.html';
            });
            return; // Stop execution until reload
        }

        // Display username
        document.getElementById('username').textContent = user.username || 'Guest';

        // Logout function
        function logout() {
            localStorage.removeItem('ares_token');
            localStorage.removeItem('ares_user');
            window.location.href = '/login.html';
        }

    // Helper function to show errors
    function showError(message) {
        const errorDiv = document.getElementById('error-message') || (() => {
            const div = document.createElement('div');
            div.id = 'error-message';
            div.style.cssText = 'position:fixed;top:20px;right:20px;background:#F6465D;color:white;padding:16px 24px;border-radius:8px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.3);font-weight:600;max-width:400px;';
            document.body.appendChild(div);
            return div;
        })();
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
    }

    // Fetch dashboard data with proper error handling
    async function fetchDashboardData() {
        // FIX #1: Check if token exists at all
        if (!token) {
            console.error('No token found - redirecting to login');
            showError('No authentication token - redirecting to login');
            setTimeout(() => { window.location.href = '/login.html'; }, 1000);
            return;
        }

        console.log('üîë Token found, fetching dashboard data...');
        console.log('Token preview:', token.substring(0, 20) + '...');

        try {
            // Fetch trading performance
            console.log('üìä Fetching /api/v1/trading/performance...');
            const perfResponse = await fetch('/api/v1/trading/performance', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            console.log('Performance API response:', perfResponse.status, perfResponse.statusText);

            // FIX #2: Handle 401 explicitly for performance endpoint
            if (perfResponse.status === 401) {
                console.error('‚ùå 401 Unauthorized - Token rejected by server');
                const errorData = await perfResponse.json().catch(() => ({}));
                console.error('Error details:', errorData);
                showError(`Session expired: ${errorData.error || 'Invalid token'} - Redirecting to login in 3 seconds...`);
                localStorage.removeItem('ares_token');
                localStorage.removeItem('ares_user');
                setTimeout(() => { window.location.href = '/login.html'; }, 3000);
                return;
            }

            if (perfResponse.ok) {
                const perfData = await perfResponse.json();
                updateTradingStats(perfData);
            }

            // Fetch playbook stats (public endpoint)
            const playbookResponse = await fetch('/api/v1/trading/playbook/stats');
            if (playbookResponse.ok) {
                const playbookData = await playbookResponse.json();
                updatePlaybookStats(playbookData);
            }

            // Fetch system health (public endpoint)
            const healthResponse = await fetch('/api/v1/monitoring/health');
            if (healthResponse.ok) {
                const healthData = await healthResponse.json();
                updateSystemStatus(healthData);
            }

            // Fetch recent trades
            const tradesResponse = await fetch('/api/v1/trading/history?limit=5', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            // FIX #3: Handle 401 for trades endpoint
            if (tradesResponse.status === 401) {
                console.error('Token expired on trades endpoint - redirecting to login');
                showError('Session expired - redirecting to login');
                localStorage.removeItem('ares_token');
                localStorage.removeItem('ares_user');
                setTimeout(() => { window.location.href = '/login.html'; }, 1500);
                return;
            }

            // FIX #4: Show error if other failure
            if (!tradesResponse.ok) {
                console.error(`Trades API error: ${tradesResponse.status}`);
                showError(`Failed to load trades: ${tradesResponse.status} ${tradesResponse.statusText}`);
            } else {
                const tradesData = await tradesResponse.json();
                updateRecentTrades(tradesData);
            }

            // Fetch playbook rules (public endpoint)
            const rulesResponse = await fetch('/api/v1/trading/playbook/');
            if (rulesResponse.ok) {
                const rulesData = await rulesResponse.json();
                updateACEActivity(rulesData);
            }

        } catch (error) {
            console.error('Error fetching dashboard data:', error);
            showError('Network error - check if API is running on port 8080');
        }
    }        function updateTradingStats(data) {
            const pnl = data.total_profit_loss || 0;
            const pnlElement = document.getElementById('totalPnL');
            
            pnlElement.textContent = `$${pnl.toFixed(2)}`;
            pnlElement.className = 'value ' + (pnl >= 0 ? 'positive' : 'negative');
            
            const winRate = data.win_rate || 0;
            document.getElementById('pnlChange').textContent = `${(winRate * 100).toFixed(1)}% win rate`;
        }

        function updatePlaybookStats(data) {
            const totalRules = data.total_rules || 0;
            const activeRules = data.active_rules || 0;
            const avgConfidence = data.avg_confidence || 0;

            document.getElementById('playbookRules').textContent = activeRules;
            document.getElementById('rulesChange').textContent = 
                `${(avgConfidence * 100).toFixed(0)}% avg confidence (${totalRules} total)`;
        }

        function updateSystemStatus(data) {
            const statusElement = document.getElementById('systemStatus');
            const detailElement = document.getElementById('statusDetail');

            if (data.status === 'healthy') {
                statusElement.innerHTML = '<span class="badge success">‚úì Healthy</span>';
                detailElement.textContent = 'All systems operational';
            } else {
                statusElement.innerHTML = '<span class="badge warning">‚ö† Degraded</span>';
                detailElement.textContent = 'Some systems need attention';
            }
        }

        function updateRecentTrades(data) {
            const container = document.getElementById('recentTradesTable');
            const trades = data.trades || [];

            if (trades.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üìä</div><p>No trades yet. SOLACE will start trading soon.</p></div>';
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Action</th>
                            <th>Amount</th>
                            <th>Price</th>
                            <th>P&L</th>
                            <th>Status</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${trades.map(trade => `
                            <tr>
                                <td><strong>${trade.symbol || 'N/A'}</strong></td>
                                <td>${trade.action || 'N/A'}</td>
                                <td>$${(trade.amount || 0).toFixed(2)}</td>
                                <td>$${(trade.price || 0).toFixed(2)}</td>
                                <td class="${(trade.profit_loss || 0) >= 0 ? 'positive' : 'negative'}">
                                    $${(trade.profit_loss || 0).toFixed(2)}
                                </td>
                                <td>
                                    <span class="badge ${trade.status === 'completed' ? 'success' : 'info'}">
                                        ${trade.status || 'pending'}
                                    </span>
                                </td>
                                <td>${new Date(trade.executed_at).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        function updateACEActivity(data) {
            const container = document.getElementById('aceActivity');
            const rules = data.rules || [];

            if (rules.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üß†</div><p>No playbook rules yet. ACE Framework will learn from trades.</p></div>';
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Rule</th>
                            <th>Category</th>
                            <th>Helpful</th>
                            <th>Harmful</th>
                            <th>Confidence</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rules.slice(0, 5).map(rule => `
                            <tr>
                                <td><strong>${rule.rule_id || 'N/A'}</strong></td>
                                <td>${rule.category || 'N/A'}</td>
                                <td>${rule.helpful_count || 0}</td>
                                <td>${rule.harmful_count || 0}</td>
                                <td>
                                    <strong class="${(rule.confidence || 0) > 0.6 ? 'positive' : 'negative'}">
                                        ${((rule.confidence || 0) * 100).toFixed(0)}%
                                    </strong>
                                </td>
                                <td>
                                    <span class="badge ${rule.is_active ? 'success' : 'warning'}">
                                        ${rule.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        // Memory count placeholder
        document.getElementById('totalMemories').textContent = '0';

        // Load data on page load
        fetchDashboardData();

        // Refresh data every 30 seconds
        setInterval(fetchDashboardData, 30000);
    </script>
</body>
</html>
