<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARES - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0B0E11;
            color: #EAECEF;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
        }

        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
        }

        .logo h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .logo p {
            font-size: 12px;
            opacity: 0.8;
        }

        .user-info {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
        }

        .user-info .username {
            font-weight: 600;
            font-size: 14px;
        }

        .user-info .role {
            font-size: 12px;
            opacity: 0.7;
        }

        .nav-menu {
            flex: 1;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            text-decoration: none;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }

        
        /* ENHANCED NAVIGATION ACTIVE STATE - High Specificity */
        .sidebar .nav-menu a.nav-item.active,
        nav.nav-menu a.nav-item.active,
        div.nav-menu a.nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border-left: 4px solid #fff !important;
            color: #fff !important;
            font-weight: 600 !important;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3) !important;
        }

        /* Hover effect for nav items */
        .sidebar .nav-menu a.nav-item:hover:not(.active) {
            background: rgba(255,255,255,0.15) !important;
            transform: translateX(2px);
            transition: all 0.2s ease;
        }

        .nav-item .icon {
            font-size: 18px;
        }

        .logout-btn {
            padding: 12px 20px;
            margin: 20px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #0B0E11;
        }

        .header {
            margin-bottom: 30px;
        }

        .header h2 {
            font-size: 28px;
            margin-bottom: 5px;
            color: #EAECEF;
        }

        .header p {
            color: #848E9C;
            font-size: 14px;
        }

        /* TradingView Chart Section */
        .chart-section {
            background: #1E2329;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            border: 1px solid #2B3139;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #2B3139;
        }

        .chart-header h3 {
            font-size: 20px;
            color: #EAECEF;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .symbol-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #EAECEF;
        }

        .symbol-selector select {
            padding: 6px 12px;
            border: 1px solid #2B3139;
            border-radius: 4px;
            background: #0B0E11;
            color: #EAECEF;
            font-size: 14px;
        }

        #tradingview_chart {
            height: 500px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            background: #0B0E11;
        }

        /* Health Gauges */
        .health-gauges {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .gauge-label {
            color: #848E9C;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .circular-gauge svg {
            filter: drop-shadow(0 0 10px rgba(102, 126, 234, 0.3));
        }

        .circular-gauge circle {
            transition: stroke-dashoffset 0.5s ease;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1E2329;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid #2B3139;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .stat-card .label {
            font-size: 14px;
            color: #848E9C;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #EAECEF;
        }

        .stat-card .value.positive {
            color: #0ECB81;
        }

        .stat-card .value.negative {
            color: #F6465D;
        }

        .stat-card .change {
            font-size: 12px;
            color: #848E9C;
        }

        /* Agent Cards */
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .agent-card {
            background: linear-gradient(135deg, #1E2329 0%, #181C21 100%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
            border: 1px solid #2B3139;
            position: relative;
            overflow: hidden;
        }

        .agent-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .agent-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            border-color: #667eea;
        }

        .agent-card:hover::before {
            opacity: 1;
        }

        .agent-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 12px;
        }

        .agent-icon {
            font-size: 32px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-size: 18px;
            font-weight: 700;
            color: #EAECEF;
            letter-spacing: 0.5px;
        }

        .agent-role {
            font-size: 12px;
            color: #848E9C;
            margin-top: 2px;
        }

        .agent-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            position: relative;
        }

        .agent-status-indicator.active {
            background: #0ECB81;
            box-shadow: 0 0 10px rgba(14, 203, 129, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }

        .agent-status-indicator.inactive {
            background: #848E9C;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .agent-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .agent-stat {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .agent-stat .stat-label {
            font-size: 11px;
            color: #848E9C;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .agent-stat .stat-value {
            font-size: 14px;
            font-weight: 600;
            color: #EAECEF;
        }

        .agent-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .progress-fill.inactive {
            background: #848E9C;
        }

        .progress-text {
            font-size: 11px;
            color: #848E9C;
            min-width: 80px;
            text-align: right;
        }

        /* Thought Stream */
        .thought-stream {
            background: #0B0E11;
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #2B3139;
        }

        .thought-stream::-webkit-scrollbar {
            width: 8px;
        }

        .thought-stream::-webkit-scrollbar-track {
            background: #1E2329;
            border-radius: 4px;
        }

        .thought-stream::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .thought-stream::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        .thought-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 260px;
            color: #848E9C;
            text-align: center;
        }

        .placeholder-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .thought-placeholder p {
            font-size: 16px;
            margin: 0 0 5px 0;
        }

        .thought-placeholder small {
            font-size: 12px;
            opacity: 0.7;
        }

        .thought-bubble {
            background: linear-gradient(135deg, #1E2329 0%, #252D36 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 3px solid #667eea;
            animation: slideIn 0.3s ease-out;
            position: relative;
        }

        .thought-bubble.trade {
            border-left-color: #0ECB81;
        }

        .thought-bubble.analysis {
            border-left-color: #667eea;
        }

        .thought-bubble.reflection {
            border-left-color: #FCD535;
        }

        .thought-bubble.error {
            border-left-color: #F6465D;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .thought-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .thought-type {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #EAECEF;
        }

        .thought-type-icon {
            font-size: 14px;
        }

        .thought-time {
            font-size: 11px;
            color: #848E9C;
        }

        .thought-content {
            font-size: 14px;
            color: #B7BDC6;
            line-height: 1.5;
        }

        .thought-metadata {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .thought-meta-item {
            font-size: 11px;
            color: #848E9C;
        }

        .thought-meta-item strong {
            color: #EAECEF;
        }

        .btn-icon {
            background: none;
            border: none;
            color: #848E9C;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            color: #667eea;
            transform: scale(1.1);
        }

        /* Content Sections */
        .section {
            background: #1E2329;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            border: 1px solid #2B3139;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #2B3139;
        }

        .section-header h3 {
            font-size: 20px;
            color: #EAECEF;
        }

        .section-header .view-all {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
        }

        .section-header .view-all:hover {
            text-decoration: underline;
            color: #8b9fea;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #0B0E11;
        }

        th {
            text-align: left;
            padding: 12px;
            font-weight: 600;
            font-size: 13px;
            color: #848E9C;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px;
            border-top: 1px solid #2B3139;
            color: #EAECEF;
        }

        tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.success {
            background: rgba(14, 203, 129, 0.1);
            color: #0ECB81;
            border: 1px solid #0ECB81;
        }

        .badge.danger {
            background: rgba(246, 70, 93, 0.1);
            color: #F6465D;
            border: 1px solid #F6465D;
        }

        .badge.info {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 1px solid #667eea;
        }

        .badge.warning {
            background: rgba(255, 184, 0, 0.1);
            color: #FFB800;
            border: 1px solid #FFB800;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #848E9C;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #848E9C;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .positive {
            color: #0ECB81 !important;
        }

        .negative {
            color: #F6465D !important;
        }

        /* Bazil Rewards Styling */
        .bazil-rewards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .reward-card {
            background: #1E2329;
            border: 1px solid #2B3139;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .reward-card:hover {
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        .reward-type {
            font-size: 12px;
            color: #848E9C;
            text-transform: uppercase;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .reward-points {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 10px 0;
        }

        .reward-label {
            font-size: 11px;
            color: #848E9C;
        }

        .status-badge {
            background: #0ECB81;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h1>ARES</h1>
                <p>Autonomous AI Trading System</p>
            </div>

            <div class="user-info">
                <div class="username" id="username">Loading...</div>
                <div class="role">Administrator</div>
            </div>

            <nav class="nav-menu">
                <a href="/dashboard.html" class="nav-item active">
                    <span class="icon">🏠</span>
                    <span>Dashboard</span>
                </a>
                <a href="/trading.html" class="nav-item">
                    <span class="icon">📊</span>
                    <span>Trading</span>
                </a>
                <a href="/solace-trading.html" class="nav-item">
                    <span class="icon">🧠</span>
                    <span>SOLACE Consciousness</span>
                </a>
                <a href="/forge-dashboard.html" class="nav-item">
                    <span class="icon">🎓</span>
                    <span>FORGE Apprenticeship</span>
                </a>
                <a href="/code-ide.html" class="nav-item">
                    <span class="icon">🤖</span>
                    <span>Code IDE</span>
                </a>
                <a href="/chat.html" class="nav-item">
                    <span class="icon">💬</span>
                    <span>Chat</span>
                </a>
                <a href="/solace-control.html" class="nav-item">
                    <span class="icon">🎛️</span>
                    <span>SOLACE Control</span>
                </a>
                <a href="/editor.html" class="nav-item">
                    <span class="icon">📝</span>
                    <span>Editor</span>
                </a>
                <a href="/memory.html" class="nav-item">
                    <span class="icon">🧠</span>
                    <span>Memory</span>
                </a>
                <a href="/vision.html" class="nav-item">
                    <span class="icon">👁️</span>
                    <span>Vision</span>
                </a>
                <a href="/health.html" class="nav-item">
                    <span class="icon">❤️</span>
                    <span>Health</span>
                </a>
            </nav>

            <div class="logout-btn" onclick="logout()">
                🚪 Logout
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h2>Mission Control</h2>
                <p>Master Dashboard - Real-Time System Monitoring & Agent Orchestration</p>
            </div>

            <!-- System Health Panel -->
            <div class="chart-section">
                <div class="chart-header">
                    <h3>🖥️ System Health Monitor</h3>
                    <div class="chart-controls">
                        <span id="healthStatus" class="badge success">OPERATIONAL</span>
                    </div>
                </div>
                <div class="health-gauges">
                    <div class="gauge-container">
                        <div class="gauge-label">CPU Usage</div>
                        <div class="circular-gauge" id="cpuGauge">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="50" fill="none" stroke="#2B3139" stroke-width="10"/>
                                <circle id="cpuCircle" cx="60" cy="60" r="50" fill="none" stroke="#667eea" stroke-width="10" 
                                    stroke-dasharray="314" stroke-dashoffset="314" transform="rotate(-90 60 60)"/>
                                <text x="60" y="65" text-anchor="middle" fill="#EAECEF" font-size="20" font-weight="bold" id="cpuText">0%</text>
                            </svg>
                        </div>
                    </div>
                    <div class="gauge-container">
                        <div class="gauge-label">Memory</div>
                        <div class="circular-gauge" id="memGauge">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="50" fill="none" stroke="#2B3139" stroke-width="10"/>
                                <circle id="memCircle" cx="60" cy="60" r="50" fill="none" stroke="#0ECB81" stroke-width="10" 
                                    stroke-dasharray="314" stroke-dashoffset="314" transform="rotate(-90 60 60)"/>
                                <text x="60" y="65" text-anchor="middle" fill="#EAECEF" font-size="20" font-weight="bold" id="memText">0%</text>
                            </svg>
                        </div>
                    </div>
                    <div class="gauge-container">
                        <div class="gauge-label">Disk Space</div>
                        <div class="circular-gauge" id="diskGauge">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="50" fill="none" stroke="#2B3139" stroke-width="10"/>
                                <circle id="diskCircle" cx="60" cy="60" r="50" fill="none" stroke="#FFB800" stroke-width="10" 
                                    stroke-dasharray="314" stroke-dashoffset="314" transform="rotate(-90 60 60)"/>
                                <text x="60" y="65" text-anchor="middle" fill="#EAECEF" font-size="20" font-weight="bold" id="diskText">0%</text>
                            </svg>
                        </div>
                    </div>
                    <div class="gauge-container">
                        <div class="gauge-label">API Latency</div>
                        <div class="circular-gauge" id="latencyGauge">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="50" fill="none" stroke="#2B3139" stroke-width="10"/>
                                <circle id="latencyCircle" cx="60" cy="60" r="50" fill="none" stroke="#F6465D" stroke-width="10" 
                                    stroke-dasharray="314" stroke-dashoffset="314" transform="rotate(-90 60 60)"/>
                                <text x="60" y="60" text-anchor="middle" fill="#EAECEF" font-size="18" font-weight="bold" id="latencyText">0</text>
                                <text x="60" y="75" text-anchor="middle" fill="#848E9C" font-size="10">ms</text>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent Status Grid -->
            <div class="section" style="margin-bottom: 30px;">
                <div class="section-header">
                    <h3>🤖 AI Agent Swarm Status</h3>
                    <span class="badge success" id="swarmStatus">4 AGENTS ACTIVE</span>
                </div>
                <div class="agent-grid">
                    <!-- SOLACE Agent -->
                    <div class="agent-card" id="agentSOLACE">
                        <div class="agent-header">
                            <div class="agent-icon">🧠</div>
                            <div class="agent-info">
                                <div class="agent-name">SOLACE</div>
                                <div class="agent-role">Strategic Director & Consciousness</div>
                            </div>
                            <div class="agent-status-indicator active"></div>
                        </div>
                        <div class="agent-stats">
                            <div class="agent-stat">
                                <span class="stat-label">Status:</span>
                                <span class="stat-value" id="solaceStatus">Active</span>
                            </div>
                            <div class="agent-stat">
                                <span class="stat-label">Current Task:</span>
                                <span class="stat-value" id="solaceTask">Monitoring markets...</span>
                            </div>
                            <div class="agent-stat">
                                <span class="stat-label">Uptime:</span>
                                <span class="stat-value" id="solaceUptime">--:--:--</span>
                            </div>
                            <div class="agent-stat">
                                <span class="stat-label">Decisions:</span>
                                <span class="stat-value" id="solaceDecisions">0</span>
                            </div>
                        </div>
                        <div class="agent-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="solaceProgress" style="width: 0%"></div>
                            </div>
                            <span class="progress-text" id="solaceProgressText">Idle</span>
                        </div>
                    </div>

                    <!-- FORGE Agent -->
                    <div class="agent-card" id="agentFORGE">
                        <div class="agent-header">
                            <div class="agent-icon">⚒️</div>
                            <div class="agent-info">
                                <div class="agent-name">FORGE</div>
                                <div class="agent-role">Code Builder & Copilot Apprentice</div>
                            </div>
                            <div class="agent-status-indicator active"></div>
                        </div>
                        <div class="agent-stats">
                            <div class="agent-stat">
                                <span class="stat-label">Status:</span>
                                <span class="stat-value" id="forgeStatus">Active</span>
                            </div>
                            <div class="agent-stat">
                                <span class="stat-label">Current Task:</span>
                                <span class="stat-value" id="forgeTask">Standby</span>
                            </div>
                            <div class="agent-stat">
                                <span class="stat-label">Patterns Learned:</span>
                                <span class="stat-value" id="forgePatterns">0</span>
                            </div>
                            <div class="agent-stat">
                                <span class="stat-label">Confidence:</span>
                                <span class="stat-value" id="forgeConfidence">0%</span>
                            </div>
                        </div>
                        <div class="agent-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="forgeProgress" style="width: 0%"></div>
                            </div>
                            <span class="progress-text" id="forgeProgressText">Ready</span>
                        </div>
                    </div>

                    <!-- ARCHITECT Agent -->
                    <div class="agent-card" id="agentARCHITECT">
                        <div class="agent-header">
                            <div class="agent-icon">📐</div>
                            <div class="agent-info">
                                <div class="agent-name">ARCHITECT</div>
                                <div class="agent-role">Design Planner & System Designer</div>
                            </div>
                            <div class="agent-status-indicator inactive"></div>
                        </div>
                        <div class="agent-stats">
                            <div class="agent-stat">
                                <span class="stat-label">Status:</span>
                                <span class="stat-value" id="architectStatus">Not Implemented</span>
                            </div>
                            <div class="agent-stat">
                                <span class="stat-label">Current Task:</span>
                                <span class="stat-value" id="architectTask">N/A</span>
                            </div>
                            <div class="agent-stat">
                                <span class="stat-label">Blueprints:</span>
                                <span class="stat-value" id="architectBlueprints">0</span>
                            </div>
                            <div class="agent-stat">
                                <span class="stat-label">Designs:</span>
                                <span class="stat-value" id="architectDesigns">0</span>
                            </div>
                        </div>
                        <div class="agent-progress">
                            <div class="progress-bar">
                                <div class="progress-fill inactive" style="width: 0%"></div>
                            </div>
                            <span class="progress-text">Awaiting Implementation</span>
                        </div>
                    </div>

                    <!-- SENTINEL Agent -->
                    <div class="agent-card" id="agentSENTINEL">
                        <div class="agent-header">
                            <div class="agent-icon">🛡️</div>
                            <div class="agent-info">
                                <div class="agent-name">SENTINEL</div>
                                <div class="agent-role">Debugger & Quality Assurance</div>
                            </div>
                            <div class="agent-status-indicator inactive"></div>
                        </div>
                        <div class="agent-stats">
                            <div class="agent-stat">
                                <span class="stat-label">Status:</span>
                                <span class="stat-value" id="sentinelStatus">Not Implemented</span>
                            </div>
                            <div class="agent-stat">
                                <span class="stat-label">Current Task:</span>
                                <span class="stat-value" id="sentinelTask">N/A</span>
                            </div>
                            <div class="agent-stat">
                                <span class="stat-label">Tests Run:</span>
                                <span class="stat-value" id="sentinelTests">0</span>
                            </div>
                            <div class="agent-stat">
                                <span class="stat-label">Bugs Found:</span>
                                <span class="stat-value" id="sentinelBugs">0</span>
                            </div>
                        </div>
                        <div class="agent-progress">
                            <div class="progress-bar">
                                <div class="progress-fill inactive" style="width: 0%"></div>
                            </div>
                            <span class="progress-text">Awaiting Implementation</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SOLACE Thought Stream -->
            <div class="section" style="margin-bottom: 30px;">
                <div class="section-header">
                    <h3>💭 SOLACE Thought Stream</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span class="badge success" id="streamStatus">● LIVE</span>
                        <button class="btn-icon" onclick="clearThoughtStream()" title="Clear stream">
                            🗑️
                        </button>
                    </div>
                </div>
                <div class="thought-stream" id="thoughtStream">
                    <div class="thought-placeholder">
                        <div class="placeholder-icon">🧠</div>
                        <p>Waiting for SOLACE to make decisions...</p>
                        <small>Real-time thoughts will appear here</small>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="label">Total P&L (24h)</div>
                    <div class="value positive" id="totalPnL">Loading...</div>
                    <div class="change" id="pnlChange">Calculating...</div>
                </div>

                <div class="stat-card">
                    <div class="label">Playbook Rules</div>
                    <div class="value" id="playbookRules">Loading...</div>
                    <div class="change" id="rulesChange">Active learning rules</div>
                </div>

                <div class="stat-card">
                    <div class="label">Total Memories</div>
                    <div class="value" id="totalMemories">Loading...</div>
                    <div class="change">Stored in semantic database</div>
                </div>

                <div class="stat-card">
                    <div class="label">Active Trades</div>
                    <div class="value" id="activeTrades">0</div>
                    <div class="change" id="tradesDetail">No active positions</div>
                </div>
            </div>

            <!-- Bazil Self-Healing Rewards -->
            <div class="section">
                <div class="section-header">
                    <h3>🏆 Bazil Self-Healing Rewards</h3>
                    <span class="status-badge" id="bazilStatus">Active</span>
                </div>
                <div id="bazil-rewards" class="bazil-rewards-grid">
                    <div class="loading">Loading rewards...</div>
                </div>
            </div>

            <!-- Recent Trades -->
            <div class="section">
                <div class="section-header">
                    <h3>Recent Trades</h3>
                    <a href="/trading.html" class="view-all">View All →</a>
                </div>
                <div id="recentTradesTable">
                    <div class="loading">Loading trades...</div>
                </div>
            </div>

            <!-- ACE Framework Activity -->
            <div class="section">
                <div class="section-header">
                    <h3>ACE Framework Activity</h3>
                    <a href="/trading.html#playbook" class="view-all">View Playbook →</a>
                </div>
                <div id="aceActivity">
                    <div class="loading">Loading ACE insights...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Display username from localStorage
        let user = {};
        try {
            const userStr = localStorage.getItem('ares_user');
            if (userStr && userStr !== 'undefined') {
                user = JSON.parse(userStr);
            }
        } catch (e) {
            console.error('Failed to parse user data:', e);
        }
        
        // Check token - if invalid, redirect to login
        const token = localStorage.getItem('ares_token');
        if (!token || token === 'undefined' || token === 'null') {
            console.log('No valid token - redirecting to login');
            window.location.href = '/login.html';
        } else {
            // Display username
            document.getElementById('username').textContent = user.username || 'Guest';
        }

        // Logout function
        function logout() {
            localStorage.removeItem('ares_token');
            localStorage.removeItem('ares_user');
            window.location.href = '/login.html';
        }

    // Helper function to show errors
    function showError(message) {
        const errorDiv = document.getElementById('error-message') || (() => {
            const div = document.createElement('div');
            div.id = 'error-message';
            div.style.cssText = 'position:fixed;top:20px;right:20px;background:#F6465D;color:white;padding:16px 24px;border-radius:8px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.3);font-weight:600;max-width:400px;';
            document.body.appendChild(div);
            return div;
        })();
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
    }

    // Fetch dashboard data with proper error handling
    async function fetchDashboardData() {
        // Reload token from localStorage (in case auto-login just set it)
        const token = localStorage.getItem('ares_token');
        
        // FIX #1: Check if token exists at all
        if (!token) {
            console.error('No token found - redirecting to login');
            showError('No authentication token - redirecting to login');
            setTimeout(() => { window.location.href = '/login.html'; }, 1000);
            return;
        }

        console.log('🔑 Token found, fetching dashboard data...');
        console.log('Token type:', typeof token, 'Length:', token?.length);
        if (token && typeof token === 'string' && token.length > 20) {
            console.log('Token preview:', token.substring(0, 20) + '...');
        } else {
            console.log('Token value:', token);
        }

        try {
            // Fetch trading performance
            console.log('📊 Fetching /api/v1/trading/performance...');
            const perfResponse = await fetch('/api/v1/trading/performance', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            console.log('Performance API response:', perfResponse.status, perfResponse.statusText);

            // FIX #2: Handle 401 explicitly for performance endpoint
            if (perfResponse.status === 401) {
                console.error('❌ 401 Unauthorized - Token rejected by server');
                const errorData = await perfResponse.json().catch(() => ({}));
                console.error('Error details:', errorData);
                showError(`Session expired: ${errorData.error || 'Invalid token'} - Redirecting to login in 3 seconds...`);
                localStorage.removeItem('ares_token');
                localStorage.removeItem('ares_user');
                setTimeout(() => { window.location.href = '/login.html'; }, 3000);
                return;
            }

            if (perfResponse.ok) {
                const perfData = await perfResponse.json();
                updateTradingStats(perfData);
            }

            // Fetch playbook stats (SKIP - endpoint requires auth, not critical for dashboard)
            // TODO: Move playbook/stats endpoint before auth middleware if needed
            console.log('⏭️ Skipping playbook stats (requires auth)');

            // Fetch system health (SKIP - endpoint deprecated, use /metrics instead)
            console.log('⏭️ Skipping system health (deprecated endpoint)');

            // Fetch recent trades (NO AUTH - moved before middleware in Patch #15)
            const tradesResponse = await fetch('/api/v1/trading/history?limit=5');
            
            if (tradesResponse.ok) {
                const tradesData = await tradesResponse.json();
                // FIX: Check if tradesData has trades array, if not create empty array
                if (tradesData && tradesData.trades) {
                    updateRecentTrades(tradesData);
                } else {
                    console.log('No trades data returned, showing empty state');
                    updateRecentTrades({ trades: [] });
                }
            } else {
                console.error(`Trades API error: ${tradesResponse.status}`);
                updateRecentTrades({ trades: [] }); // Show empty state on error
            }

            // Fetch playbook rules (SKIP - requires auth)
            console.log('⏭️ Skipping playbook rules (requires auth)');

        } catch (error) {
            console.error('Error fetching dashboard data:', error);
            showError('Network error - check if API is running on port 8080');
        }
    }        function updateTradingStats(data) {
            const pnl = data.total_profit_loss || 0;
            const pnlElement = document.getElementById('totalPnL');
            
            pnlElement.textContent = `$${pnl.toFixed(2)}`;
            pnlElement.className = 'value ' + (pnl >= 0 ? 'positive' : 'negative');
            
            const winRate = data.win_rate || 0;
            document.getElementById('pnlChange').textContent = `${(winRate * 100).toFixed(1)}% win rate`;
        }

        function updatePlaybookStats(data) {
            const totalRules = data.total_rules || 0;
            const activeRules = data.active_rules || 0;
            const avgConfidence = data.avg_confidence || 0;

            document.getElementById('playbookRules').textContent = activeRules;
            document.getElementById('rulesChange').textContent = 
                `${(avgConfidence * 100).toFixed(0)}% avg confidence (${totalRules} total)`;
        }

        function updateSystemStatus(data) {
            const statusElement = document.getElementById('systemStatus');
            const detailElement = document.getElementById('statusDetail');

            // Safety check - elements might not exist on page
            if (!statusElement || !detailElement) {
                console.warn('System status elements not found on page');
                return;
            }

            if (data.status === 'healthy') {
                statusElement.innerHTML = '<span class="badge success">✓ Healthy</span>';
                detailElement.textContent = 'All systems operational';
            } else {
                statusElement.innerHTML = '<span class="badge warning">⚠ Degraded</span>';
                detailElement.textContent = 'Some systems need attention';
            }
        }

        function updateAgentStatus() {
            fetch('/api/v1/monitoring/health', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('ares_token') || ''}`
                }
            })
            .then(response => response.json())
            .then(data => {
                // SOLACE Agent - always active (it's the main agent)
                const solaceUptime = data.uptime_seconds || 0;
                const hours = Math.floor(solaceUptime / 3600);
                const minutes = Math.floor((solaceUptime % 3600) / 60);
                const seconds = solaceUptime % 60;
                document.getElementById('solaceUptime').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                document.getElementById('solaceStatus').textContent = data.status === 'healthy' ? 'Active' : 'Degraded';
                document.getElementById('solaceTask').textContent = data.status === 'healthy' ? 'Monitoring markets & executing strategies' : 'Recovering...';
                document.getElementById('solaceDecisions').textContent = Math.floor(Math.random() * 1000); // TODO: Wire to real data
                
                const solaceProgress = data.status === 'healthy' ? 85 : 30;
                document.getElementById('solaceProgress').style.width = `${solaceProgress}%`;
                document.getElementById('solaceProgressText').textContent = `${solaceProgress}% efficiency`;

                // FORGE Agent - check if code generation is available
                const forgeActive = data.services && data.services.ollama === 'healthy';
                const forgeCard = document.getElementById('agentFORGE');
                const forgeIndicator = forgeCard.querySelector('.agent-status-indicator');
                
                if (forgeActive) {
                    forgeIndicator.classList.add('active');
                    forgeIndicator.classList.remove('inactive');
                    document.getElementById('forgeStatus').textContent = 'Active';
                    document.getElementById('forgeTask').textContent = 'Learning patterns...';
                    document.getElementById('forgePatterns').textContent = Math.floor(Math.random() * 50);
                    document.getElementById('forgeConfidence').textContent = '73%';
                    document.getElementById('forgeProgress').style.width = '73%';
                    document.getElementById('forgeProgressText').textContent = 'Learning';
                } else {
                    forgeIndicator.classList.remove('active');
                    forgeIndicator.classList.add('inactive');
                    document.getElementById('forgeStatus').textContent = 'Offline';
                    document.getElementById('forgeTask').textContent = 'Ollama not available';
                }

                // ARCHITECT & SENTINEL - Not implemented yet
                // Leave as-is (showing "Not Implemented" from HTML)

                // Update swarm status badge
                const activeCount = (data.status === 'healthy' ? 1 : 0) + (forgeActive ? 1 : 0);
                document.getElementById('swarmStatus').textContent = `${activeCount} AGENTS ACTIVE`;
            })
            .catch(err => {
                console.error('Failed to update agent status:', err);
            });
        }

        function updateRecentTrades(data) {
            const container = document.getElementById('recentTradesTable');
            const trades = data.trades || [];

            if (trades.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">📊</div><p>No trades yet. SOLACE will start trading soon.</p></div>';
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Action</th>
                            <th>Amount</th>
                            <th>Price</th>
                            <th>P&L</th>
                            <th>Status</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${trades.map(trade => `
                            <tr>
                                <td><strong>${trade.symbol || 'N/A'}</strong></td>
                                <td>${trade.action || 'N/A'}</td>
                                <td>$${(trade.amount || 0).toFixed(2)}</td>
                                <td>$${(trade.price || 0).toFixed(2)}</td>
                                <td class="${(trade.profit_loss || 0) >= 0 ? 'positive' : 'negative'}">
                                    $${(trade.profit_loss || 0).toFixed(2)}
                                </td>
                                <td>
                                    <span class="badge ${trade.status === 'completed' ? 'success' : 'info'}">
                                        ${trade.status || 'pending'}
                                    </span>
                                </td>
                                <td>${new Date(trade.executed_at).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        function updateACEActivity(data) {
            const container = document.getElementById('aceActivity');
            const rules = data.rules || [];

            if (rules.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">🧠</div><p>No playbook rules yet. ACE Framework will learn from trades.</p></div>';
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Rule</th>
                            <th>Category</th>
                            <th>Helpful</th>
                            <th>Harmful</th>
                            <th>Confidence</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rules.slice(0, 5).map(rule => `
                            <tr>
                                <td><strong>${rule.rule_id || 'N/A'}</strong></td>
                                <td>${rule.category || 'N/A'}</td>
                                <td>${rule.helpful_count || 0}</td>
                                <td>${rule.harmful_count || 0}</td>
                                <td>
                                    <strong class="${(rule.confidence || 0) > 0.6 ? 'positive' : 'negative'}">
                                        ${((rule.confidence || 0) * 100).toFixed(0)}%
                                    </strong>
                                </td>
                                <td>
                                    <span class="badge ${rule.is_active ? 'success' : 'warning'}">
                                        ${rule.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        // SOLACE Thought Stream
        let thoughtStreamMessages = [];
        const MAX_THOUGHTS = 50;

        function addThought(type, content, metadata = {}) {
            const timestamp = new Date();
            const thought = {
                type: type, // 'trade', 'analysis', 'reflection', 'error'
                content: content,
                metadata: metadata,
                timestamp: timestamp
            };

            thoughtStreamMessages.push(thought);
            
            // Keep only last MAX_THOUGHTS messages
            if (thoughtStreamMessages.length > MAX_THOUGHTS) {
                thoughtStreamMessages.shift();
            }

            renderThoughtStream();
        }

        function renderThoughtStream() {
            const container = document.getElementById('thoughtStream');
            
            if (thoughtStreamMessages.length === 0) {
                container.innerHTML = `
                    <div class="thought-placeholder">
                        <div class="placeholder-icon">🧠</div>
                        <p>Waiting for SOLACE to make decisions...</p>
                        <small>Real-time thoughts will appear here</small>
                    </div>
                `;
                return;
            }

            const thoughtIcons = {
                trade: '💰',
                analysis: '🔍',
                reflection: '💡',
                error: '⚠️'
            };

            const thoughtHTML = thoughtStreamMessages.map(thought => {
                const icon = thoughtIcons[thought.type] || '📝';
                const time = thought.timestamp.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });

                let metaHTML = '';
                if (Object.keys(thought.metadata).length > 0) {
                    metaHTML = '<div class="thought-metadata">';
                    for (const [key, value] of Object.entries(thought.metadata)) {
                        metaHTML += `<div class="thought-meta-item"><strong>${key}:</strong> ${value}</div>`;
                    }
                    metaHTML += '</div>';
                }

                return `
                    <div class="thought-bubble ${thought.type}">
                        <div class="thought-header">
                            <div class="thought-type">
                                <span class="thought-type-icon">${icon}</span>
                                <span>${thought.type.toUpperCase()}</span>
                            </div>
                            <div class="thought-time">${time}</div>
                        </div>
                        <div class="thought-content">${thought.content}</div>
                        ${metaHTML}
                    </div>
                `;
            }).reverse().join(''); // Newest first

            container.innerHTML = thoughtHTML;
            
            // Auto-scroll to top (newest message)
            container.scrollTop = 0;
        }

        function clearThoughtStream() {
            thoughtStreamMessages = [];
            renderThoughtStream();
        }

        // Simulate SOLACE thoughts (replace with real WebSocket when ready)
        function simulateThoughts() {
            const thoughts = [
                { type: 'analysis', content: 'Analyzing BTC/USDT market conditions. RSI at 62.4, MACD showing bullish divergence.', metadata: { Symbol: 'BTC/USDT', Signal: 'Bullish' } },
                { type: 'trade', content: 'Executing long position on ETH/USDT. Entry: $2,450. Target: $2,520. Stop: $2,400.', metadata: { Action: 'LONG', Size: '0.5 ETH', Risk: '2%' } },
                { type: 'reflection', content: 'Previous trade closed with +3.2% profit. Pattern recognition confidence increased to 78%.', metadata: { 'P&L': '+$156', Confidence: '78%' } },
                { type: 'analysis', content: 'Volume spike detected on SOL/USDT. Monitoring for breakout confirmation above $140.', metadata: { Symbol: 'SOL/USDT', Volume: '+340%' } },
                { type: 'trade', content: 'Closing partial position on BTC/USDT. Booking 60% profit, letting 40% run with trailing stop.', metadata: { Action: 'CLOSE', Profit: '+$420' } },
                { type: 'reflection', content: 'Market volatility increasing. Reducing position sizes by 30% to manage risk.', metadata: { Volatility: 'High', Adjustment: '-30%' } },
                { type: 'error', content: 'API rate limit reached on Binance. Waiting 60 seconds before retry.', metadata: { Exchange: 'Binance', Retry: '60s' } },
                { type: 'analysis', content: 'Multiple timeframe alignment on ADA/USDT. H1, H4, and D1 all showing uptrend.', metadata: { Symbol: 'ADA/USDT', Alignment: '3/3' } }
            ];

            let thoughtIndex = 0;
            setInterval(() => {
                const thought = thoughts[thoughtIndex % thoughts.length];
                addThought(thought.type, thought.content, thought.metadata);
                thoughtIndex++;
            }, 8000); // Add new thought every 8 seconds
        }

        // Memory count placeholder
        document.getElementById('totalMemories').textContent = '0';

        // Load data on page load
        fetchDashboardData();
        updateAgentStatus();
        simulateThoughts();
        loadBazilRewards();

        // Refresh data every 30 seconds
        setInterval(fetchDashboardData, 30000);
        
        // Refresh agent status every 10 seconds
        setInterval(updateAgentStatus, 10000);
        
        // Refresh Bazil rewards every 60 seconds
        setInterval(loadBazilRewards, 60000);

        // System Health Gauges Update
        function updateHealthGauges() {
            fetch('/api/v1/monitoring/metrics')
                .then(response => response.json())
                .then(data => {
                    // Update CPU Gauge (use GoroutineCount as proxy - scale to 0-100 where 1000 goroutines = 100%)
                    const goroutines = data.GoroutineCount || 0;
                    const cpuPercent = Math.min((goroutines / 1000) * 100, 100);
                    updateGauge('cpu', cpuPercent, cpuPercent > 80 ? '#F6465D' : '#667eea');
                    
                    // Update Memory Gauge (convert MB to percentage - assume 1024MB = 100%)
                    const memoryMB = data.MemoryUsageMB || 0;
                    const memPercent = Math.min((memoryMB / 1024) * 100, 100);
                    updateGauge('mem', memPercent, memPercent > 80 ? '#F6465D' : '#0ECB81');
                    
                    // Update Disk Gauge (use DB connections as proxy - scale to 0-100 where 100 connections = 100%)
                    const dbConns = data.DBConnections || 0;
                    const diskPercent = Math.min((dbConns / 100) * 100, 100);
                    updateGauge('disk', diskPercent, diskPercent > 85 ? '#F6465D' : '#FFB800');
                    
                    // Update Latency Gauge (use LLM avg latency)
                    const latency = data.LLMAvgLatencyMs || data.AvgResponseTimeMs || 0;
                    const latencyPercent = Math.min((latency / 200) * 100, 100);
                    updateGauge('latency', latencyPercent, latency > 100 ? '#F6465D' : '#0ECB81', latency + 'ms');
                    
                    // Update overall status badge
                    const statusBadge = document.getElementById('healthStatus');
                    if (cpuPercent > 90 || memPercent > 90 || diskPercent > 95) {
                        statusBadge.className = 'badge danger';
                        statusBadge.textContent = 'CRITICAL';
                    } else if (cpuPercent > 80 || memPercent > 80 || diskPercent > 85) {
                        statusBadge.className = 'badge warning';
                        statusBadge.textContent = 'DEGRADED';
                    } else {
                        statusBadge.className = 'badge success';
                        statusBadge.textContent = 'OPERATIONAL';
                    }
                })
                .catch(err => console.error('Health check failed:', err));
        }

        function updateGauge(id, percent, color, customText = null) {
            const circumference = 314; // 2 * PI * 50
            const offset = circumference - (percent / 100) * circumference;
            
            const circle = document.getElementById(id + 'Circle');
            const text = document.getElementById(id + 'Text');
            
            if (circle) {
                circle.style.stroke = color;
                circle.style.strokeDashoffset = offset;
            }
            
            if (text) {
                text.textContent = customText || Math.round(percent) + '%';
            }
        }

        // Update health gauges every 5 seconds
        updateHealthGauges();
        setInterval(updateHealthGauges, 5000);

        // Load Bazil Self-Healing Rewards
        function loadBazilRewards() {
            // Bazil rewards endpoint doesn't exist yet - show placeholder
            const container = document.getElementById('bazil-rewards');
            if (container) {
                container.innerHTML = `
                    <div style="text-align:center;padding:20px;color:#888;">
                        <div class="icon">🛠️</div>
                        <p>Bazil self-healing system coming soon</p>
                        <small>Endpoint not yet implemented</small>
                    </div>
                `;
            }
            return;
            
            /* DISABLED - Endpoint doesn't exist yet
            // Uncomment when /api/v1/bazil/rewards is implemented:
            /*
            fetch('/api/v1/bazil/rewards')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('bazil-rewards');
                    
                    // If no rewards yet, show empty state
                    if (!data || Object.keys(data).length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">🔍</div>
                                <p>No faults detected yet</p>
                                <small>Bazil is monitoring the codebase</small>
                            </div>
                        `;
                        return;
                    }
                    
                    // Render reward cards
                    let html = '';
                    for (const [faultType, points] of Object.entries(data)) {
                        html += `
                            <div class="reward-card">
                                <div class="reward-type">${faultType.replace(/_/g, ' ')}</div>
                                <div class="reward-points">${points}</div>
                                <div class="reward-label">points earned</div>
                            </div>
                        `;
                    }
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Failed to load Bazil rewards:', error);
                    document.getElementById('bazil-rewards').innerHTML = `
                        <div class="empty-state">
                            <div class="icon">⚠️</div>
                            <p>Failed to load rewards</p>
                            <small>Check API connection</small>
                        </div>
                    `;
                });
            */
        }
    </script>

    <!-- Removed TradingView - Now on dedicated Trading page -->
    <script>
        // Chart moved to /trading.html for dedicated trading interface
        // Dashboard is now mission control for system monitoring
        
        // WebSocket for live data
        const ws = new WebSocket('ws://localhost:8080/api/v1/solace/ws');
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log('📨 Dashboard WebSocket received:', data.type, data);
            
            if (data.type === 'metrics') {
                const cpuElem = document.querySelector('.cpu-usage');
                const memElem = document.querySelector('.memory-usage');
                if (cpuElem) cpuElem.textContent = data.cpu + '%';
                if (memElem) memElem.textContent = data.memory + '%';
            } else if (data.type === 'thought_stream') {
                const thoughtElem = document.getElementById('solace-thoughts');
                if (thoughtElem) thoughtElem.innerHTML += `<p>${data.thought}</p>`;
            } else if (data.type === 'trade_executed') {
                // Handle live trade execution updates
                console.log('🟢 Trade executed via WebSocket:', data.data);
                // Refresh trading stats and recent trades
                fetchDashboardData();
            } else if (data.type === 'price_update') {
                // Handle live price updates
                console.log('💹 Price update via WebSocket:', data.data);
                // Update any price displays if needed
            } else if (data.type === 'solace_decision') {
                // Handle SOLACE decision updates
                console.log('🧠 SOLACE decision via WebSocket:', data.data);
                // Add to thought stream
                const thoughtElem = document.getElementById('solace-thoughts');
                if (thoughtElem && data.data) {
                    thoughtElem.innerHTML += `<p><strong>Decision:</strong> ${JSON.stringify(data.data)}</p>`;
                }
            }
        };
        ws.onerror = (e) => console.error('WS error:', e);
        ws.onopen = () => console.log('✅ Dashboard WebSocket connected');
        ws.onclose = () => console.log('❌ Dashboard WebSocket disconnected');

        // Enhanced button click handlers with nav sync and active state
        document.addEventListener('DOMContentLoaded', () => {
            const navItems = document.querySelectorAll('.nav-item');
            const currentPage = window.location.pathname.split('/').pop() || 'dashboard.html';
            
            // Set active state on load
            navItems.forEach(item => {
                const href = item.getAttribute('href');
                if (href && href.includes(currentPage)) {
                    item.classList.add('active');
                }
                
                // Click handler with validation and active state sync
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const targetHref = item.getAttribute('href');
                    if (!targetHref) {
                        console.warn('Nav item has no href:', item);
                        return;
                    }
                    
                    // Remove active from all items
                    navItems.forEach(i => i.classList.remove('active'));
                    
                    // Add active to clicked item
                    item.classList.add('active');
                    
                    // Publish nav change via WebSocket
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'nav_change',
                            page: targetHref,
                            timestamp: Date.now()
                        }));
                    }
                    
                    // Navigate with fallback
                    const normalizedHref = targetHref.startsWith('/') ? targetHref : '/' + targetHref;
                    console.log('Navigating to:', normalizedHref);
                    window.location.href = normalizedHref;
                });
            });
            
            console.log('✅ Nav sync initialized:', navItems.length, 'items');
        });
    </script>
</body>
</html>
